# syntax=docker/dockerfile:1

ARG PY_VERSION="3.11"

FROM balenalib/raspberrypi4-64-ubuntu-python:${PY_VERSION}-jammy-build as loopy_base

# gdb --args something arg arg
RUN apt-get update && apt-get install -y gcc rsync

RUN CMAKE_BUILD_PARALLEL_LEVEL=$(nproc) pip install z3-solver==4.12.1.0 cmake -vvvv

FROM loopy_base as loopy

ARG WORKDIR="repo"

ADD . $WORKDIR

WORKDIR $WORKDIR

RUN pip install -r requirements.txt -vvvv

RUN pip wheel . --no-deps --no-build-isolation -vvvv -w wheelhouse && rm -rf loopy.egg-info

RUN pip install wheelhouse/$(ls wheelhouse | head -1) --no-build-isolation

RUN cd tests && pytest *.py